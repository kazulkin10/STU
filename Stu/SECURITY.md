# Безопасность Stu

## Цели и угрозы

- Защищаем: содержимое сообщений (E2EE X3DH + Double Ratchet), целостность сессий (opaque токены + device binding), приватность ключей (хранятся только у клиента), доверенная доставка (TLS, WS auth), конфиденциальность репортов (отдельный ключ модерации).
- Частично защищаем: метаданные (минимизация/TTL, но IP/факт подключения остаются у провайдера), большие группы в серверном режиме, атаки на скомпрометированное устройство пользователя.
- Не защищаем: фишинг/социальная инженерия вне приложения, модифицированный клиент, side-channel анализ трафика по размерам/таймингу.

## Меры

- Транспорт: TLS 1.2+, HSTS, CSP, строгий CORS, CSRF токены для web.
- Токены: opaque access/refresh, ротация, привязка к устройству (fingerprint), хранение в httpOnly cookie (клиент) или secure storage.
- Пароли: bcrypt, rate limit по IP/email (Redis), аудит логинов.
- Крипта: X25519 ECDH, Ed25519 подписи, HKDF, AEAD ChaCha20-Poly1305 или AES-GCM. Safety number/QR для проверки ключей.
- Ключи: сервер хранит только публичные identity/prekeys. Один signed prekey + пачка one-time prekeys. Sender keys для групп (ротация). Ключи клиента шифруются паролем/OS keystore.
- Логи/метаданные: JSON с request-id, хранение по TTL, минимальный объём. Audit для админ-операций и репортов.
- Уведомления: push только метаданные без содержимого, опционально полностью отключаемые.
- Репорты: анализ только по жалобе, используется зашифрованный report packet (отдельный публичный ключ модерации), фото/видео — копии, присланные пользователем.

## Проверки и тесты

- Юнит-тесты крипты/токенов (расширять).
- Интеграционные тесты: регистрация/логин/refresh, отправка сообщений (после реализации), прогон миграций в CI.
- Линтеры: golangci-lint, ruff/black.
- Пентест чеклист: MITM (safety number), CSRF/CORS, brute-force rate limit, JWT/opaque token theft, SSRF в preview, RCE в media pipeline, ограничение uploads, безопасные presigned URL TTL.

## Процесс обновлений

- Ротация ключей доступа к Timeweb/MailerSend только через ENV.
- Регулярная ротация signed prekey и sender keys.
- План отката: systemd/compose с предыдущим образом, миграции должны быть обратимы или снабжены down-скриптами (будут добавлены).
