# ТЗ (кратко)

Stu — приватный мессенджер с UX уровня Telegram, но с безопасностью уровня Signal. Цель: удобное домашнее приложение (web/PWA, desktop), разворачиваемое на одном сервере, с E2EE по умолчанию, прозрачной криптографией и отказом от сбора лишних метаданных. Основа — Go монорепозиторий с микросервисами (gateway, auth, realtime, media, admin), Python сервис модерации (только по жалобам), PostgreSQL, Redis, MinIO, gRPC внутренний, HTTP/JSON для клиентов, WebSocket + fallback. Клиентская крипта/протокол — общая Go библиотека (WASM/Go mobile).

## Основные функции (обязательный чеклист)

- Аккаунт: регистрация/вход по e-mail с подтверждением (код/ссылка), 2FA, восстановление, управление сессиями/устройствами, профиль, настройки приватности.
- Сообщения: 1:1 E2EE, группы (малые — E2EE, большие — sender keys или серверный режим), каналы (с опцией приватного шифрования), реакции, ответы, пересылка, цитаты, упоминания, черновики, редакт/удаление, пины, предпросмотр ссылок, поиск, закрепы, архивы, фильтры.
- Медиа/файлы: фото/видео/аудио/голосовые/файлы, сжатие/превью на клиенте, прогресс/докачка, лимиты, хранение в MinIO (S3) с подписанными ссылками и TTL.
- Реалтайм/статусы: онлайн/печатает/прочитал, типизация событий new_message/message_edit/delete/typing/read_receipt/presence/call_signal.
- Звонки: 1:1 голос (WebRTC) с E2EE; каркас для групповых.
- Уведомления: web push + интерфейс для мобильных push; mute, DND, исключения.
- Контакты/соц: поиск по username/e-mail (по согласию), блокировки, жалобы, анти-спам, инвайты/роли в группах/каналах.
- Синхронизация: история, пагинация, исходящая очередь, ретраи, конфликт-резолюция.
- Модерация: только по жалобам через report packet (отдельный ключ), Python moderation-agent (классификация), автоматические меры + админ-панель.
- Админ-панель: управление жалобами, решения, апелляции, статистика.
- Инфра/качество: миграции, линтеры, тесты (unit+integration), метрики (Prometheus), логирование (JSON, request-id), health checks, docker-compose dev/prod, systemd, nginx.

## Threat model (что защищаем / не можем)

**Защищаем**: содержимое сообщений (E2EE, forward secrecy, post-compromise security), ключи пользователей (хранятся на клиентах, защищены паролем/OS keystore), целостность сессий (device-bound токены, refresh rotation), каналы WebSocket (TLS + auth), конфиденциальность репортов (отдельный ключ), минимизация метаданных (агрегация/TTL), защита от MITM (safety number/QR верификация), CSRF/CORS/secure cookies, rate limit/abuse detection.

**Не защищаем полностью**: сетевой уровень без TLS (провайдер видит IP/факт подключения), компрометацию устройства пользователя, большие группы при серверном режиме (метаданные групп), анализ трафика по таймингу/размеру пакетов, доступ к бэкапам если админ нарушает процедуры, вредоносный клиент (модификация бинаря), целевой фишинг вне приложения.

## Схема сервисов и потоков данных (текстовое описание)

- `api-gateway` (HTTP/JSON + gRPC proxy): аутентификация, REST/PWA API, выдача presigned URL, прокси к внутренним сервисам; авторизация через opaque session + refresh, JWT только внутри.
- `auth`: регистрация/логин/2FA, управление устройствами/сессиями, refresh/rotation, e-mail коды (MailerSend), аудит.
- `realtime`: WebSocket/long-poll, delivery событий, presence/typing/read receipts, хранение очередей в Redis, интеграция с `crypto/protocol` для сигнальных пакетов.
- `media`: прием/upload, генерация превью, прокси к MinIO, генерация подписанных ссылок/TTL, антивирус/лимиты.
- `admin`: админ-панель, управление жалобами/банами, статистика, конфиг.
- `moderation-agent` (Python): принимает report packet (зашифрованный отдельным ключом), классифицирует контент, публикует решение в очередь (Redis/HTTP callback).
- Общие: PostgreSQL (данные, миграции), Redis (кэш, очереди, presence), MinIO (S3), Prometheus/Grafana, Loki или файловые логи, nginx как reverse proxy (TLS/HSTS).
- Клиент: `client/web` (PWA, TS + Go WASM либ), `client/shared-go` (протокол и криптография, применяется в клиентах/сервисах), push adapter для мобильных.

## Выбор криптопротокола и библиотек

- Сигнальный протокол: X3DH + Double Ratchet (Noise-like) с prekeys/signed prekeys, аналог libsignal. Используем `golang.org/x/crypto` примитивы + `github.com/fxamacker/cbor/v2` для сериализации пакетов + собственная реализация double ratchet в `pkg/crypto/ratchet` (покрыть тестами).
- Проверка ключей: safety number/QR (hash от публичных ключей устройства), хранение у клиента, сравнение оффлайн.
- KDF/HKDF: `crypto/hkdf`, AEAD: `crypto/chacha20poly1305` (или AES-GCM при наличии AES-NI). Подписи: Ed25519 (`crypto/ed25519`). ECDH: X25519.
- Transport: TLS 1.2+ с HSTS, WebSocket поверх TLS, HTTP/2 для gRPC.
- Хранение: сервер хранит только публичные ключи/предключи, сообщения — только E2EE шифротекст + метаданные (минимум). Ключи устройств шифруются на клиенте (пароль/OS keystore).

## Политика групп/каналов и E2EE

- Малые группы: Double Ratchet на основе sender keys (per-sender), пересылка через сервер только шифротексты.
- Большие группы: опция server-side (с сохранением метаданных) или sender keys с ротацией; по умолчанию предлагаем sender keys, но предупреждаем о возможных накладных расходах.
- Каналы: обычный режим без E2EE (контент на сервере) + режим «приватный канал» — публикации шифруются ключом канала, распределяемым подписчикам через E2EE директ.

## Чекпоинты реализации (итерации)

1. Auth + e-mail подтверждение + базовый клиентский вход/выход/2FA.
2. Realtime + список чатов/диалогов.
3. E2EE 1:1 (X3DH + Double Ratchet), верификация ключей.
4. Медиа/файлы + прогресс + MinIO.
5. Группы (sender keys) + роли + инвайты.
6. Каналы + приватный режим.
7. Репорты + moderation-agent + админ-панель.
8. Звонки 1:1 (каркас WebRTC) + сигнальные сообщения.
9. Полировка: метрики, логирование, интеграционные тесты, деплой/systemd.

## UX-направление

Интерфейс полностью на русском, “домашний” и аккуратный: колонка чатов слева, чат справа, верхняя панель с поиском/фильтрами, быстрые реакции/черновики. Светлая и тёмная темы, умеренные анимации, доступность (клавиатура/контраст). Без платных функций.
